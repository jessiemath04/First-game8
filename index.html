<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessie Math - ä¸‰è§’å½¢å†’éšªæŒ‘æˆ°åŸºç¤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary-yellow: #FFB700; 
            --bg-blue: #f8fbff; 
            --accent-orange: #FF5722; 
            --success-green: #4CAF50; 
            --error-red: #f44336;
            --jessie-blue: #3F51B5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-blue); }

        /* --- Hero & Nav --- */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 40px; background: white; 
            box-shadow: 0 1px 5px rgba(0,0,0,0.05); 
            position: sticky; top: 0; z-index: 100; 
        }
        .brand-box { display: flex; align-items: center; }
        .logo-circle { 
            width: 50px; height: 50px; background-color: var(--primary-yellow); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            margin-right: 15px; overflow: hidden;
        }
        .logo-circle img { width: 90%; height: auto; background: transparent; }
        .brand-text { font-size: 28px; font-weight: bold; color: #2c3e50; }

        nav { display: flex; align-items: center; gap: 10px; }
        .nav-btn {
            text-decoration: none; color: #555; font-size: 14px;
            padding: 8px 15px; border: 1px solid #e0e0e0;
            border-radius: 25px; display: flex; align-items: center; gap: 5px; transition: 0.3s;
        }
        .nav-btn:hover { background: #f5f5f5; border-color: #ccc; }
        .nav-btn.blue-border { border-color: var(--jessie-blue); color: var(--jessie-blue); }

        /* --- Layout --- */
        #main-wrapper { max-width: 600px; margin: 20px auto; padding: 10px; }
        .screen { display: none; background: white; border-radius: 25px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; position: relative; }
        .screen.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #pause-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 80; border-radius: 25px;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #feedback-overlay {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 90; pointer-events: none; text-align: center; width: 100%;
        }
        .flash-icon { font-size: 80px; }
        .flash-text { font-size: 26px; font-weight: bold; margin-top: 10px; }

        /* --- Game Elements --- */
        .canvas-container { width: 100%; height: 240px; background: #fafafa; border: 2px solid #f0f0f0; border-radius: 20px; margin-bottom: 20px; position: relative; display: flex; justify-content: center; align-items: center; }
        .stats { display: flex; justify-content: space-around; margin-bottom: 15px; font-weight: bold; font-size: 20px; }
        .btn { border: none; padding: 12px 20px; border-radius: 12px; font-size: 16px; cursor: pointer; transition: 0.2s; margin: 5px; color: white; font-weight: bold; }
        .btn-main { background: var(--accent-orange); width: 85%; }
        .btn-ans { background: #4dabf7; min-width: 140px; }
        .btn-level { background: #4dabf7; min-width: 140px; } /* é—œå¡æŒ‰éˆ•ç¨ç«‹ class */
        
        .hint-box { font-size: 17px; color: #555; background: #fffde7; padding: 8px 12px; border-radius: 10px; display: inline-block; margin-bottom: 10px; border: 1px dashed #ffd54f; }
        .rank-table { width: 100%; margin-top: 20px; font-size: 14px; border-collapse: collapse; }
        .rank-table th, .rank-table td { padding: 8px; border-bottom: 1px solid #eee; }

        @media (max-width: 600px) {
            header { flex-direction: column; padding: 10px; }
            nav { margin-top: 10px; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand-box">
        <div class="logo-circle"><img src="JESSIEMATH-Q.png" alt="Logo"></div>
        <span class="brand-text">Jessie Math</span>
    </div>
    <nav>
        <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-btn"><i class="fas fa-home"></i>é¦–é </a>
        <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn"><i class="fas fa-gamepad"></i>éŠæˆ²å¤§å»³</a>
        <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g4-u7" class="nav-btn blue-border"><i class="fas fa-chevron-left"></i>å››å¹´ç´šä¸‰è§’å½¢èˆ‡å…¨ç­‰</a>
    </nav>
</header>

<div id="main-wrapper">
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="screen-login" class="screen active">
        <h2 style="color:var(--jessie-blue);">ä¸‰è§’å½¢å†’éšªæŒ‘æˆ°</h2>
        <input type="text" id="playerName" placeholder="è¼¸å…¥è‹±é›„åå­—..." style="padding:15px; width:85%; border:2px solid #eee; border-radius:12px; margin:25px 0; font-size: 18px;">
        <button class="btn btn-main" onclick="setPlayerAndGo()">é–‹å§‹å†’éšª</button>
    </div>

    <!-- é—œå¡é¸å–® -->
    <div id="screen-levels" class="screen">
        <h3>é¸æ“‡æŒ‘æˆ°ä»»å‹™</h3>
        <button class="btn btn-level" style="width:90%" onclick="startGame(1)">ä»»å‹™ 1: åˆ†é¡åµæ¢</button>
        <button class="btn btn-level" style="width:90%" onclick="startGame(2)">ä»»å‹™ 2: ç•«åœ–å»ºç¯‰å¸«</button>
        <button class="btn btn-level" style="width:90%" onclick="startGame(3)">ä»»å‹™ 3: å…¨ç­‰å®ˆé–€å“¡</button>
        <h4 style="margin-top:25px; color:#666;">ğŸ† æ’è¡Œæ¦œ (æœ¬æ¬¡æŒ‘æˆ°)</h4>
        <table class="rank-table" id="rank-display">
            <thead><tr><th>æ’å</th><th>è‹±é›„</th><th>å¾—åˆ†</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div id="screen-game" class="screen">
        <div id="pause-overlay">
            <h2 style="color:var(--jessie-blue); margin-bottom:20px;">æš«åœä¸­</h2>
            <button class="btn btn-main" onclick="togglePause()"><i class="fas fa-play"></i> ç¹¼çºŒéŠæˆ²</button>
        </div>
        <div id="feedback-overlay">
            <i id="feedback-icon" class="fas flash-icon"></i>
            <div id="feedback-text" class="flash-text"></div>
        </div>
        <div class="stats">
            <span id="timer" style="color:var(--error-red)">
                <i class="fas fa-clock"></i> 60s
            </span>
            <span id="score">
                <i class="fas fa-star" style="color:var(--primary-yellow)"></i> 0
            </span>
            <span id="combo">Combo x0</span>
        </div>
        <div id="hint-area"></div>
        <div id="game-content-area">
            <div class="canvas-container">
                <canvas id="gameCanvas" width="300" height="200"></canvas>
            </div>
            <div id="question-text" style="font-size: 19px; font-weight:bold; margin-bottom:15px; padding:0 10px;"></div>
            <div id="options-area" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
        </div>
        <div style="margin-top:20px; border-top: 1px solid #eee; padding-top: 15px;">
            <button class="btn" style="background:#FFC107;" onclick="togglePause()"><i class="fas fa-pause"></i> æš«åœ</button>
            <button class="btn" style="background:#8BC34A;" onclick="restartGame()"><i class="fas fa-redo"></i> é‡æ–°</button>
            <button class="btn" style="background:#607D8B;" onclick="backToMenu()"><i class="fas fa-th-large"></i> é¸å–®</button>
        </div>
    </div>

    <!-- çµç®—ç•«é¢ -->
    <div id="screen-result" class="screen">
        <h2>æŒ‘æˆ°çµæŸï¼</h2>
        <div id="star-rating" style="font-size:50px; margin:20px 0;"></div>
        <p>æœ€çµ‚å¾—åˆ†ï¼š<span id="final-score" style="font-size:36px; color:var(--accent-orange); font-weight:bold;">0</span></p>
        <button class="btn btn-main" onclick="backToMenu()">å›ä¸»é¸å–®</button>
    </div>
</div>

<script>
    // éŠæˆ²ç‹€æ…‹
    let state = { 
        playerName: 'è‹±é›„', 
        score:0, 
        timer:60, 
        combo:0, 
        level:1, 
        interval:null, 
        currentAns:null, 
        isProcessing: false, 
        isPaused: false,
        overlayTimeout: null
    };

    // æœ¬æ¬¡æŒ‘æˆ°ç”¨æ’è¡Œæ¦œï¼ˆä¸å¯« localStorageï¼‰
    let sessionRank = [];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const praiseWords = ["å¤ªæ£’äº†ï¼", "æ­£ç¢ºï¼", "æ²’éŒ¯ï¼", "å¥½å²å®³ï¼"];

    function safeClearTimers(){
        if(state.interval){
            clearInterval(state.interval);
            state.interval = null;
        }
        if(state.overlayTimeout){
            clearTimeout(state.overlayTimeout);
            state.overlayTimeout = null;
        }
    }

    function showScreen(id) {
        const screens = document.querySelectorAll('.screen');
        screens.forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'screen-levels') updateRankUI();
    }

    function setPlayerAndGo() {
        const nameInput = document.getElementById('playerName').value.trim();
        state.playerName = nameInput || 'ç„¡åè‹±é›„';
        showScreen('screen-levels');
    }

    function startGame(lv) {
        safeClearTimers();
        state.level = lv; 
        state.score = 0; 
        state.timer = 60; 
        state.combo = 0;
        state.isProcessing = false; 
        state.isPaused = false;

        document.getElementById('pause-overlay').style.display = 'none';
        document.getElementById('feedback-overlay').style.display = 'none';
        document.getElementById('game-content-area').style.visibility = 'visible';

        document.getElementById('timer').innerHTML = '<i class="fas fa-clock"></i> 60s';
        document.getElementById('score').innerHTML = '<i class="fas fa-star" style="color:var(--primary-yellow)"></i> 0';
        document.getElementById('combo').innerText = 'Combo x0';

        showScreen('screen-game');
        nextQuestion();

        state.interval = setInterval(() => {
            if(!state.isProcessing && !state.isPaused){
                state.timer--;
                if(state.timer < 0) state.timer = 0;
                document.getElementById('timer').innerHTML = '<i class="fas fa-clock"></i> ' + state.timer + 's';
                if(state.timer <= 0){
                    endGame();
                }
            }
        }, 1000);
    }

    function togglePause() {
        if(state.isProcessing) return;
        state.isPaused = !state.isPaused;
        const overlay = document.getElementById('pause-overlay');
        const content = document.getElementById('game-content-area');
        overlay.style.display = state.isPaused ? 'flex' : 'none';
        content.style.visibility = state.isPaused ? 'hidden' : 'visible';
    }

    function drawTriangle(pts, color="#2196F3", offset={x:0, y:0}) {
        ctx.beginPath();
        ctx.moveTo(pts[0].x + offset.x, pts[0].y + offset.y);
        ctx.lineTo(pts[1].x + offset.x, pts[1].y + offset.y);
        ctx.lineTo(pts[2].x + offset.x, pts[2].y + offset.y);
        ctx.closePath();
        ctx.strokeStyle = color; 
        ctx.lineWidth = 4; 
        ctx.stroke();
        ctx.fillStyle = color + "22"; 
        ctx.fill();
    }

    function nextQuestion() {
        state.isProcessing = false;
        ctx.clearRect(0,0,300,200);
        const hintArea = document.getElementById('hint-area');
        const qText = document.getElementById('question-text');
        const optArea = document.getElementById('options-area');

        hintArea.innerHTML = '';
        qText.innerText = '';
        optArea.innerHTML = '';
        
        if(state.level === 1) { // 7-1 åˆ†é¡åµæ¢
            const isAngleMode = Math.random() > 0.5;
            if(isAngleMode) {
                const types = ['ç›´è§’ä¸‰è§’å½¢', 'éˆè§’ä¸‰è§’å½¢', 'éŠ³è§’ä¸‰è§’å½¢'];
                state.currentAns = types[Math.floor(Math.random()*3)];
                const hints = { 'ç›´è§’ä¸‰è§’å½¢': 'æœ‰ä¸€è§’æ˜¯ 90 åº¦', 'éˆè§’ä¸‰è§’å½¢': 'æœ‰ä¸€è§’å¤§æ–¼ 90 åº¦', 'éŠ³è§’ä¸‰è§’å½¢': 'ä¸‰è§’éƒ½å°æ–¼ 90 åº¦' };
                hintArea.innerHTML = '<div class="hint-box">ğŸ’¡ è§’åˆ†é¡ï¼š' + hints[state.currentAns] + '</div>';
                let pts = [{x:100, y:50}, {x:100, y:150}, {x:200, y:150}];
                if(state.currentAns === 'éˆè§’ä¸‰è§’å½¢') pts = [{x:50, y:150}, {x:250, y:150}, {x:200, y:80}];
                else if(state.currentAns === 'éŠ³è§’ä¸‰è§’å½¢') pts = [{x:150, y:50}, {x:100, y:150}, {x:200, y:150}];
                drawTriangle(pts, "#E91E63");
                types.forEach(t => createAnsBtn(t));
            } else {
                const types = ['æ­£ä¸‰è§’å½¢', 'ç­‰è…°ä¸‰è§’å½¢', 'ä¸ç­‰é‚Šä¸‰è§’å½¢'];
                state.currentAns = types[Math.floor(Math.random()*3)];
                const hints = { 'æ­£ä¸‰è§’å½¢': 'ä¸‰é‚Šéƒ½ä¸€æ¨£é•·', 'ç­‰è…°ä¸‰è§’å½¢': 'æœ‰å…©é‚Šä¸€æ¨£é•·', 'ä¸ç­‰é‚Šä¸‰è§’å½¢': 'ä¸‰é‚Šéƒ½ä¸ä¸€æ¨£é•·' };
                hintArea.innerHTML = '<div class="hint-box">ğŸ’¡ é‚Šåˆ†é¡ï¼š' + hints[state.currentAns] + '</div>';
                let pts = [{x:150, y:50}, {x:80, y:160}, {x:220, y:160}];
                if(state.currentAns === 'ä¸ç­‰é‚Šä¸‰è§’å½¢') pts = [{x:80, y:60}, {x:100, y:160}, {x:240, y:150}];
                drawTriangle(pts, "#4CAF50");
                types.forEach(t => createAnsBtn(t));
            }
        } else if(state.level === 2) { // 7-2 ç•«åœ–å»ºç¯‰å¸«
            const qs = [
                {q: "é‡è§’å™¨çš„ã€Œä¸­å¿ƒé»ã€è¦å°æº–ä¸‰è§’å½¢çš„å“ªå€‹ä½ç½®ï¼Ÿ", a: "é ‚é»", o: ["é ‚é»", "é‚Š", "é«˜åº¦"]},
                {q: "æƒ³è¦ç•«å‡ºæŒ‡å®šã€Œè§’åº¦ã€çš„ä¸‰è§’å½¢ï¼Œå¿…é ˆç”¨åˆ°ï¼Ÿ", a: "é‡è§’å™¨", o: ["é‡è§’å™¨", "åœ“è¦", "ç›´è§’å°º"]},
                {q: "ä»»ä½•ä¸‰è§’å½¢ï¼Œä¸€å®šåŒ…å«å¹¾å€‹è§’å’Œå¹¾å€‹é‚Šï¼Ÿ", a: "3å€‹", o: ["2å€‹", "3å€‹", "4å€‹"]},
                {q: "ç•«ä¸‰è§’å½¢æ™‚ï¼Œé€šå¸¸æœ€å…ˆç•«å‡ºå“ªä¸€éƒ¨åˆ†ç•¶åŸºç¤ï¼Ÿ", a: "åº•é‚Š", o: ["åº•é‚Š", "é«˜", "é ‚é»"]},
                {q: "é‡è§’å™¨çš„ã€Œ0åº¦ç·šã€æ‡‰è©²è·Ÿä¸‰è§’å½¢çš„å“ªè£¡é‡åˆï¼Ÿ", a: "åº•é‚Š", o: ["åº•é‚Š", "é ‚é»", "é«˜"]},
                {q: "ä¸‰å€‹è§’éƒ½å°æ–¼ 90 åº¦çš„ä¸‰è§’å½¢å«ä»€éº¼ï¼Ÿ", a: "éŠ³è§’ä¸‰è§’å½¢", o: ["éŠ³è§’ä¸‰è§’å½¢", "éˆè§’ä¸‰è§’å½¢", "ç›´è§’ä¸‰è§’å½¢"]},
                {q: "ä¸€å€‹ä¸‰è§’å½¢ä¸­ï¼Œæœ€å¤šå¯ä»¥æœ‰å¹¾å€‹ç›´è§’ï¼Ÿ", a: "1å€‹", o: ["1å€‹", "2å€‹", "3å€‹"]},
                {q: "å…©é‚Šä¸€æ¨£é•·çš„ä¸‰è§’å½¢ï¼Œæˆ‘å€‘ç¨±å®ƒç‚ºä»€éº¼ï¼Ÿ", a: "ç­‰è…°ä¸‰è§’å½¢", o: ["ç­‰è…°ä¸‰è§’å½¢", "æ­£ä¸‰è§’å½¢", "ç›´è§’ä¸‰è§’å½¢"]},
                {q: "æ­£ä¸‰è§’å½¢çš„ä¸‰å€‹è§’éƒ½æ˜¯å¹¾åº¦ï¼Ÿ", a: "60åº¦", o: ["60åº¦", "90åº¦", "180åº¦"]},
                {q: "é—œæ–¼æ­£ä¸‰è§’å½¢ï¼Œå“ªä¸€å€‹èªªæ³•æ˜¯æ­£ç¢ºçš„ï¼Ÿ", a: "å®ƒä¹Ÿæ˜¯ç­‰è…°ä¸‰è§’å½¢", o: ["å®ƒä¹Ÿæ˜¯ç­‰è…°ä¸‰è§’å½¢", "å®ƒåªæœ‰å…©å€‹è§’ç›¸ç­‰", "å®ƒæœ‰ä¸€å€‹éˆè§’"]},
                {q: "ä¸€å€‹ä¸‰è§’å½¢ä¸­å¦‚æœæœ‰å…©å€‹è§’ç›¸ç­‰ï¼Œå®ƒä¸€å®šæ˜¯ï¼Ÿ", a: "ç­‰è…°ä¸‰è§’å½¢", o: ["ç­‰è…°ä¸‰è§’å½¢", "æ­£ä¸‰è§’å½¢", "ç›´è§’ä¸‰è§’å½¢"]}
            ];
            const pick = qs[Math.floor(Math.random()*qs.length)];
            state.currentAns = pick.a;
            qText.innerText = pick.q;
            hintArea.innerHTML = '<div class="hint-box">ğŸ—ï¸ å»ºç¯‰å¸«ä»»å‹™ï¼šæŒ‘æˆ°å¹¾ä½•å¸¸è­˜ï¼</div>';
            drawTriangle([{x:100,y:140},{x:200,y:140},{x:150,y:60}], "#FFD700");
            const options = pick.o.slice().sort(() => Math.random() - 0.5);
            options.forEach(t => createAnsBtn(t));
        } else { // 7-3 å…¨ç­‰å®ˆé–€å“¡
            const isC = Math.random() > 0.5;
            state.currentAns = isC ? "å…¨ç­‰" : "ä¸å…¨ç­‰";
            qText.innerText = "é€™å…©å€‹åœ–å½¢èƒ½å®Œå…¨é‡åˆ(å…¨ç­‰)å—ï¼Ÿ";
            const p1 = [{x:40, y:80}, {x:100, y:80}, {x:70, y:30}];
            drawTriangle(p1, "#9C27B0", {x:0, y:50});
            const p2 = isC ? p1 : [{x:40, y:80}, {x:120, y:90}, {x:70, y:20}];
            drawTriangle(p2, "#FF9800", {x:130, y:50});
            ["å…¨ç­‰", "ä¸å…¨ç­‰"].forEach(t => createAnsBtn(t));
        }
    }

    function createAnsBtn(text) {
        const optArea = document.getElementById('options-area');
        const b = document.createElement('button');
        b.className = 'btn btn-ans'; 
        b.innerText = text;
        b.onclick = () => {
            if(state.isPaused || state.isProcessing) return;
            state.isProcessing = true;
            document.querySelectorAll('.btn-ans').forEach(btn => btn.disabled = true);

            const isCorrect = (text === state.currentAns);
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('feedback-icon');
            const txt = document.getElementById('feedback-text');

            if(isCorrect) {
                state.score += 10; 
                state.timer += 5; 
                state.combo++;
                icon.className = "fas fa-check-circle flash-icon";
                icon.style.color = "var(--success-green)";
                txt.innerText = praiseWords[Math.floor(Math.random()*praiseWords.length)];
                txt.style.color = "var(--success-green)";
                overlay.style.display = 'block';

                updateUI();
                state.overlayTimeout = setTimeout(() => { 
                    overlay.style.display = 'none'; 
                    nextQuestion(); 
                }, 600);
            } else {
                state.timer -= 5; 
                if(state.timer < 0) state.timer = 0;
                state.combo = 0;
                icon.className = "fas fa-times-circle flash-icon";
                icon.style.color = "var(--error-red)";
                txt.innerText = 'æ­£ç¢ºç­”æ¡ˆï¼š' + state.currentAns;
                txt.style.color = "var(--error-red)";
                overlay.style.display = 'block';

                updateUI();
                state.overlayTimeout = setTimeout(() => { 
                    overlay.style.display = 'none'; 
                    nextQuestion(); 
                }, 1500);
            }
        };
        optArea.appendChild(b);
    }

    function updateUI() {
        document.getElementById('score').innerHTML = '<i class="fas fa-star" style="color:var(--primary-yellow)"></i> ' + state.score;
        document.getElementById('combo').innerText = 'Combo x' + state.combo;
        document.getElementById('timer').innerHTML = '<i class="fas fa-clock"></i> ' + state.timer + 's';
    }

    function backToMenu() { 
        safeClearTimers();
        state.isProcessing = false;
        state.isPaused = false;
        document.getElementById('pause-overlay').style.display = 'none';
        document.getElementById('feedback-overlay').style.display = 'none';
        showScreen('screen-levels'); 
    }

    function restartGame() { 
        startGame(state.level); 
    }

    function updateRankUI() {
        const tbody = document.querySelector('#rank-display tbody');
        let html = '';
        sessionRank.forEach((r, i) => {
            if(i < 5){
                html += `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.score}</td></tr>`;
            }
        });
        tbody.innerHTML = html;
    }

    function endGame() {
        safeClearTimers();
        state.isProcessing = true;

        sessionRank.push({ name: state.playerName, score: state.score });
        sessionRank.sort((a,b) => b.score - a.score);
        if (sessionRank.length > 5) sessionRank = sessionRank.slice(0,5);

        document.getElementById('final-score').innerText = state.score;
        const star = document.getElementById('star-rating');
        star.innerText = state.score > 200 ? "â­â­â­" : (state.score > 100 ? "â­â­" : "â­");
        showScreen('screen-result');
    }

    // ä¸€é–‹å§‹æ›´æ–°ä¸€æ¬¡æ’è¡Œæ¦œï¼ˆç©ºçš„ï¼‰
    updateRankUI();
</script>
</body>
</html>
